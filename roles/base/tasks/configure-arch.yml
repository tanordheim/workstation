---

- name: Install core packages
  community.general.pacman:
    name:
      - openssh
      - zsh
  become: true

- name: Create user group
  ansible.builtin.group:
    name: trond
    gid: 1000
  become: true

- name: Create user
  ansible.builtin.user:
    name: trond
    uid: 1000
    comment: Trond Nordheim
    shell: /bin/zsh
    group: trond
    groups: [wheel]
  become: true

- name: Allow sudo for created user
  ansible.builtin.copy:
    src: trond-sudo
    dest: /etc/sudoers.d/trond
    owner: root
    group: root
    mode: '0440'
  become: true

- name: Allow passwordless pacman for created user
  ansible.builtin.copy:
    src: trond-pacman-sudo
    dest: /etc/sudoers.d/trond-pacman
    owner: root
    group: root
    mode: '0440'
  become: true

- name: Install yay AUR helper
  ansible.builtin.shell:
    cmd: |
      git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin
      cd /tmp/yay-bin
      makepkg -si --noconfirm > /tmp/makepkg.log
      rm -rf /tmp/yay-bin
    creates: /usr/bin/yay
  vars:
    ansible_remote_tmp: /tmp
  register: yay_installed
  become: true
  become_user: trond # become and become_user required since this runs as root for the first time during bootstrap.

- name: Generate yay AUR helper database
  ansible.builtin.shell: yay -Y --gendb
  become: true
  when: yay_installed.changed

- name: Create local bin directory
  ansible.builtin.file:
    path: /home/trond/.local/bin
    recurse: true
    owner: trond
    group: trond
    mode: '0755'
    state: directory

- name: Prepare SSH key directory
  ansible.builtin.file:
    path: /home/trond/.ssh
    owner: trond
    group: trond
    mode: '0750'
    state: directory

- name: Install SSH public key
  ansible.builtin.copy:
    dest: /home/trond/.ssh/id_rsa.pub
    content: "{{ ssh.public_key }}"
    owner: trond
    group: trond
    mode: '0640'

- name: Install SSH private key
  ansible.builtin.copy:
    dest: /home/trond/.ssh/id_rsa
    content: "{{ ssh.private_key }}"
    owner: trond
    group: trond
    mode: '0600'

- name: Set default X11 keymap
  ansible.builtin.shell:
    cmd: localectl set-x11-keymap no
    creates: /etc/X11/xorg.conf.d/00-keyboard.conf
  become: true
